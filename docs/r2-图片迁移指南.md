# Cloudflare R2 图片迁移指南

本文档用于将博客中外链图片（如 `cdn.gooo.ai`）迁移到 Cloudflare R2，并切换为你的自定义图片域名（如 `img.ninthbit.org`）。

## 1. 目标与方案

推荐方案：`R2 + 自定义域名`

- 你当前是 Astro 静态站，图片主要是存储与分发场景。
- R2 迁移成本低，后续维护简单。
- 如果未来需要动态裁剪/缩略图，再叠加 Cloudflare Images 即可。

## 2. 迁移前准备

1. 创建 R2 bucket（例如 `zenblog-images`）。
2. 给 bucket 绑定自定义域名（例如 `img.ninthbit.org`）。
3. 本地安装并登录 Wrangler：

```bash
npx wrangler whoami
```

如果未登录：

```bash
npx wrangler login
```

## 3. 本仓库内置脚本

已提供两个脚本：

- `scripts/r2-upload-external-images.mjs`：扫描 Markdown/MDX 中的外链图片，下载后上传到 R2。
- `scripts/replace-image-host.mjs`：批量将内容中的旧域名替换为新域名。

`package.json` 中也有快捷命令（见下文）。

## 4. 执行迁移

### 步骤 1：先扫描，不上传

```bash
bun run r2:images:upload -- --bucket=zenblog-images --dry-run
```

可选：指定源域名（默认 `cdn.gooo.ai`）

```bash
bun run r2:images:upload -- --bucket=zenblog-images --source-host=cdn.gooo.ai --dry-run
```

### 步骤 2：上传到 R2

```bash
bun run r2:images:upload -- --bucket=zenblog-images --source-host=cdn.gooo.ai
```

说明：脚本默认使用 `wrangler r2 object put --remote`，会上传到线上 R2，而不是本地模拟存储。
并且默认 `--skip-existing=true`，已存在的对象不会重复上传。

如果你已经先执行了域名替换（内容里已是 `cdn.ninthbit.org`），可这样补传：

```bash
bun run r2:images:upload -- --bucket=zenblog-images --match-host=cdn.ninthbit.org --fetch-host=cdn.gooo.ai
```

如果你明确需要覆盖同名对象，可关闭跳过：

```bash
bun run r2:images:upload -- --bucket=zenblog-images --match-host=cdn.ninthbit.org --fetch-host=cdn.gooo.ai --skip-existing=false
```

脚本会保留 URL 路径作为对象 key，例如：

- `https://cdn.gooo.ai/web-images/abc.png`
- 上传为：`web-images/abc.png`

### 步骤 3：预览替换结果

```bash
bun run r2:images:replace -- --from-host=cdn.gooo.ai --to-host=img.ninthbit.org
```

### 步骤 4：写入替换

```bash
bun run r2:images:replace -- --from-host=cdn.gooo.ai --to-host=img.ninthbit.org --apply
```

### 步骤 5：构建与验证

```bash
bun run build
```

重点检查：

- 文章头图（hero/fallback）
- 正文内图片
- RSS 与 OG 图片不受影响

## 5. 建议的 Cloudflare 配置

1. 给 `img.ninthbit.org/*` 配置较长 CDN 缓存（静态图片可 1 年）。
2. 图片 URL 使用稳定 key（不要频繁覆盖同名）。
3. 如需覆盖同名文件，发布后执行一次相关路径缓存清理。

## 6. 中国可访问性说明（架构决策重点）

- 对中国大陆访客，Cloudflare 全球网络通常可访问，但稳定性受跨境链路与运营商质量影响，可能出现波动。
- 若你对中国大陆稳定性有较高 SLA 要求，需要评估 Cloudflare 中国网络（企业方案）与合规要求（如备案等）。
- 官方文档（截至 2025-10/11）还注明：
  - Cloudflare 中国网络是 Enterprise 的单独订阅能力，并要求 ICP。
  - 在中国网络语境下，R2 有“大陆内创建与自定义域名支持”方面的限制，需结合 Global Acceleration 评估。
- 实操上建议：
  - 使用单独图片域名（已采用）
  - 做多地网络实测（电信/联通/移动）
  - 保留降级策略（关键图可本地静态兜底）

官方参考：

- https://developers.cloudflare.com/china-network/
- https://developers.cloudflare.com/china-network/reference/available-products/
- https://developers.cloudflare.com/china-network/faq/
- https://developers.cloudflare.com/r2/buckets/public-buckets/

## 7. 常见问题

### Q1: 上传脚本报 wrangler 未登录
先执行：

```bash
npx wrangler login
```

若命令运行环境是非交互（如 CI/自动化），还需要设置：

```bash
export CLOUDFLARE_API_TOKEN=你的token
```

### Q2: 想先小范围验证
可先在测试文章里替换 1-2 张图，确认线上访问后再全量执行。

### Q3: 未来要自动压缩/多尺寸
后续可接入 Cloudflare Images 或 Worker 做按需转换，不影响当前 R2 URL 结构。
