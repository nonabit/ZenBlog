---
import type { CollectionEntry } from "astro:content";
import BaseHead from "../components/BaseHead.astro";
import FusionHeader from "../components/react/FusionHeader";
import FusionFooter from "../components/react/FusionFooter";
import ScrollProgress from "../components/react/ScrollProgress";
import GiscusComments from "../components/react/GiscusComments";
import DefaultAvatar from "../assets/avatar.jpg";
import { Calendar, Clock } from "lucide-react";
import { translations } from "@/i18n/translations";

type Props = CollectionEntry<"blog">["data"] & {
    slug?: string;
    readTimeMinutes?: number;
    fallbackHeroImage?: string;
};

const {
    title,
    description,
    pubDate,
    heroImage,
    author,
    slug,
    readTimeMinutes,
    fallbackHeroImage,
} = Astro.props;

// 检测语言：根据 URL 路径判断
const lang = Astro.url.pathname.startsWith("/zh/") ? "zh" : "en";
const t = translations[lang];

// 构建当前文章的完整路径
const currentPath = slug
    ? (lang === "zh" ? `/zh/blog/${slug}` : `/blog/${slug}`)
    : (lang === "zh" ? "/zh/blog" : "/blog");

// 简单的日期格式化
const formattedDate = pubDate.toLocaleDateString(
    lang === "zh" ? "zh-CN" : "en-US",
    {
        year: "numeric",
        month: "long",
        day: "numeric",
    },
);

const readTimeLabel =
    lang === "zh"
        ? `${Math.max(1, readTimeMinutes ?? 5)} 分钟阅读`
        : `${Math.max(1, readTimeMinutes ?? 5)} min read`;
const sectionLabel = "WORK INSIGHTS";
const authorName = author?.name ?? "静水深流";
const authorTitle =
    author?.title ?? "天行健，君子以自强不息";
const authorAvatar = author?.avatar ?? DefaultAvatar.src;
const heroImageSrc = typeof heroImage === "string" ? heroImage : heroImage?.src;
const coverImageSrc = heroImageSrc || fallbackHeroImage;
---

<!-- 优化 1: 将语言改为 zh-CN，有助于浏览器正确渲染中文字体 -->
<html lang={lang === "zh" ? "zh" : "en"}>
    <head>
        <!-- 保留你的 OG Image 逻辑 -->
        <BaseHead
            title={title}
            description={description}
            image={`/og/${Astro.params.slug}.png`}
        />
    </head>

    <body
        class="bg-white dark:bg-black text-zinc-800 dark:text-zinc-200 transition-colors duration-500 antialiased font-sans"
    >
        <!-- 1. 进度条 -->
        <ScrollProgress client:load />

        <!-- 2. 全局导航 (保留你的 transition:persist) -->
        <FusionHeader
            client:load
            currentPath={currentPath}
            lang={lang}
            translations={t}
        />

        <main class="max-w-7xl mx-auto px-6 py-12 sm:py-20 relative z-10">
            <article
                class="animate-in fade-in slide-in-from-bottom-4 duration-700"
            >
                <header class="mx-auto w-full max-w-3xl mb-12">
                    <p
                        class="text-xs font-medium uppercase tracking-[0.18em] text-zinc-500 dark:text-zinc-400 mb-6"
                    >
                        {sectionLabel}
                    </p>
                    <div
                        class="flex items-center gap-4 text-xs font-mono text-zinc-400 mb-6 uppercase tracking-wider"
                    >
                        <span class="flex items-center gap-1">
                            <Clock size={12} /> {readTimeLabel}
                        </span>
                        <span class="w-px h-3 bg-zinc-200 dark:bg-zinc-800"
                        ></span>
                        <span class="flex items-center gap-1">
                            <Calendar size={12} />
                            {formattedDate}
                        </span>
                    </div>

                    <h1
                        class="text-[2.2rem] sm:text-[2.9rem] font-semibold text-zinc-900 dark:text-zinc-100 leading-[1.2] mb-8"
                        style={lang === "zh" ? "font-family: var(--font-serif)" : "font-family: var(--font-serif-en)"}
                    >
                        {title}
                    </h1>
                </header>

                {
                    coverImageSrc && (
                        <div class="relative aspect-[16/10] sm:aspect-[21/9] w-full overflow-hidden border border-zinc-200 dark:border-zinc-800 mb-12 bg-zinc-50 dark:bg-zinc-900">
                            <img
                                src={coverImageSrc}
                                alt={title}
                                class="object-cover w-full h-full"
                            />
                        </div>
                    )
                }

                <section class="mx-auto w-full max-w-xl">
                    <p
                        class="text-xl sm:text-2xl leading-relaxed text-zinc-900 dark:text-zinc-100 mb-7"
                        style={lang === "zh" ? "font-family: var(--font-serif)" : "font-family: var(--font-serif-en)"}
                    >
                        {description}
                    </p>

                    <div class="inline-flex items-center gap-3">
                        <img
                            src={authorAvatar}
                            alt={authorName}
                            class="h-10 w-10 rounded-full object-cover border border-zinc-200 dark:border-zinc-700"
                            loading="lazy"
                        />
                        <div>
                            <p class="text-sm font-semibold text-zinc-900 dark:text-zinc-100 leading-none mb-0.5">
                                {authorName}
                            </p>
                            <p class="text-xs text-zinc-500 dark:text-zinc-400">
                                {authorTitle}
                            </p>
                        </div>
                    </div>

                    <hr class="border-zinc-200 dark:border-zinc-800 mt-6" />
                </section>

                <!-- 4. Markdown 正文 - 使用自定义 prose 样式 -->
                <div class="prose mx-auto max-w-xl">
                    <slot />
                </div>
            </article>

            <!-- 5. 评论区 -->
            <section
                class="mx-auto w-full max-w-xl mt-16 pt-12 border-t border-zinc-100 dark:border-zinc-800"
            >
                <h2
                    class="text-2xl font-semibold text-zinc-900 dark:text-zinc-100 mb-8"
                    style={lang === "zh" ? "font-family: var(--font-serif)" : "font-family: var(--font-serif-en)"}
                >
                    {lang === "zh" ? "评论" : "Comments"}
                </h2>
                <GiscusComments client:load lang={lang} />
            </section>
        </main>

        {/* 统一的页脚 */}
        <FusionFooter client:visible translations={t} />
    </body>
</html>
