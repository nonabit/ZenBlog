---
import BaseHead from "../../components/BaseHead.astro";
import SiliconBackground from "../../components/react/SiliconBackground";
import FusionHeader from "../../components/react/FusionHeader";
import FusionHome from "../../components/react/FusionHome";
import FusionFooter from "../../components/react/FusionFooter";
import { SITE_TITLE, SITE_DESCRIPTION } from "../../consts";
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";
import type { BlogListItem } from "../../types/content";
import { translations } from "@/i18n/translations";

const lang = 'zh';
const t = translations[lang];

const allPosts = (await getCollection("blog")).sort(
	(a: CollectionEntry<"blog">, b: CollectionEntry<"blog">) =>
		b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
);

const posts: BlogListItem[] = allPosts.map((post: CollectionEntry<"blog">) => ({
	slug: post.id.replace(/\.[^/.]+$/, ""),
	data: {
		title: post.data.title,
		description: post.data.description,
		pubDate: post.data.pubDate,
		showOnHome: post.data.showOnHome === true,
	},
}));

const homePosts = posts.filter((p) => p.data.showOnHome === true).slice(0, 5);
---

<!doctype html>
<html lang="zh">
	<head>
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
		<script is:inline>
			const theme = (() => {
				if (
					typeof localStorage !== "undefined" &&
					localStorage.getItem("theme")
				) {
					return localStorage.getItem("theme");
				}
				if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
					return "dark";
				}
				return "light";
			})();
			if (theme === "dark") {
				document.documentElement.classList.add("dark");
			} else {
				document.documentElement.classList.remove("dark");
			}
		</script>
	</head>
	<body class="bg-white dark:bg-black transition-colors duration-500">
		<SiliconBackground client:load />
		<FusionHeader client:load currentPath="/zh" lang={lang} translations={t} />

		<main class="relative z-10">
			<FusionHome client:load posts={homePosts} translations={t} />
		</main>

		<FusionFooter client:visible translations={t} />
	</body>
</html>
