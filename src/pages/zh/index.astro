---
import BaseHead from "../../components/BaseHead.astro";
import FusionHeader from "../../components/react/FusionHeader";
import FusionHome from "../../components/react/FusionHome";
import FusionFooter from "../../components/react/FusionFooter";
import { SITE_TITLE, SITE_DESCRIPTION } from "../../consts";
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";
import type { BlogListItem } from "../../types/content";
import { translations } from "@/i18n/translations";

const lang = 'zh';
const t = translations[lang];

// 获取最新文章并按语言过滤（zh/ 目录），然后按发布时间倒序
const allPosts = (await getCollection("blog"))
	.filter((post: CollectionEntry<"blog">) => post.id.startsWith("zh/"))
	.sort(
		(a: CollectionEntry<"blog">, b: CollectionEntry<"blog">) =>
			b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
	);

const posts: BlogListItem[] = allPosts.map((post: CollectionEntry<"blog">) => ({
	slug: post.id.replace(/^zh\//, "").replace(/\.[^/.]+$/, ""),
	data: {
		title: post.data.title,
		description: post.data.description,
		pubDate: post.data.pubDate,
		showOnHome: post.data.showOnHome === true,
	},
}));

const homePosts = posts.filter((p) => p.data.showOnHome === true).slice(0, 5);
---

<!doctype html>
<html lang="zh">
	<head>
		<BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
	</head>
	<body class="bg-white dark:bg-black transition-colors duration-500">
		<FusionHeader client:load currentPath="/zh" lang={lang} translations={t} />

		<main class="relative z-10">
			<FusionHome client:load posts={homePosts} translations={t} lang={lang} />
		</main>

		<FusionFooter client:visible translations={t} />
	</body>
</html>
