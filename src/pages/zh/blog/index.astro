---
import BaseHead from "../../../components/BaseHead.astro";
import FusionHeader from "../../../components/react/FusionHeader";
import BlogList from "../../../components/react/BlogList";
import FusionFooter from "../../../components/react/FusionFooter";
import { SITE_TITLE } from "../../../consts";
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";
import { translations } from "@/i18n/translations";

const lang = 'zh';
const t = translations[lang];

// 1. 获取原始数据并按语言过滤（zh/ 目录），然后排序
const allPosts = (await getCollection("blog"))
	.filter((post: CollectionEntry<"blog">) => post.id.startsWith("zh/"))
	.sort(
		(a: CollectionEntry<"blog">, b: CollectionEntry<"blog">) =>
			b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
	);

// 2. 数据清洗：确保传给 React 的是纯净的 JSON 对象
const posts = allPosts.map((post: CollectionEntry<"blog">) => ({
	slug: post.id.replace(/^zh\//, "").replace(/\.[^/.]+$/, ""),
	data: {
		title: post.data.title,
		description: post.data.description,
		pubDate: post.data.pubDate,
	},
}));
---

<!doctype html>
<html lang="zh">
	<head>
		<BaseHead
			title={`${t['nav.blog']} | ${SITE_TITLE}`}
			description="Writings and thoughts."
		/>
		<script is:inline>
			const theme = (() => {
				if (
					typeof localStorage !== "undefined" &&
					localStorage.getItem("theme")
				) {
					return localStorage.getItem("theme");
				}
				if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
					return "dark";
				}
				return "light";
			})();
			if (theme === "dark") {
				document.documentElement.classList.add("dark");
			} else {
				document.documentElement.classList.remove("dark");
			}
		</script>
	</head>
	<body class="bg-white dark:bg-black transition-colors duration-500">
		{/* 头部导航 */}
		<FusionHeader client:load currentPath="/zh/blog" lang={lang} translations={t} />

		<main class="max-w-5xl mx-auto px-6 py-12 sm:py-20 relative z-10">
			{/* 博客列表组件 */}
			<BlogList client:load posts={posts} lang={lang} translations={t} />
		</main>

		{/* 统一的页脚 */}
		<FusionFooter client:visible translations={t} />
	</body>
</html>
